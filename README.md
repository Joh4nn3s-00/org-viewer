# Org Viewer — VS Code Extension

A Visual Studio Code extension that provides a **live rendered preview panel** for Emacs Org-mode (`.org`) files, mirroring the UX of VS Code's built-in Markdown preview.

Open a `.org` file, click the split-preview icon in the editor title bar (or press `Cmd+K V`), and see the rendered HTML side-by-side. Edits live-update the preview.

---

## Features

- Split-pane preview for `.org` files (same UX as Markdown preview)
- Live updates as you type
- Preview follows active editor (switching .org files updates the preview)
- Theme-aware styling (respects VS Code light/dark/high-contrast themes)
- Colored headings by level (h1=blue, h2=purple, h3=yellow, etc.)
- TODO/DONE keyword badges with color coding
- Priority cookies `[#A]`/`[#B]`/`[#C]` with color-coded badges
- Tags rendered as pill badges
- Checkbox rendering with Unicode symbols (☑/☐/☒)
- Display math (`$$...$$`) vs inline math (`$...$`) distinction
- Code blocks with language-specific tinting
- Tables with styled headers
- Planning lines (SCHEDULED/DEADLINE/CLOSED) rendered
- Property drawers and custom drawers (LOGBOOK, NOTES, etc.) rendered
- CLOCK entries with time ranges and durations
- Document metadata (#+TITLE, #+AUTHOR, #+DATE, etc.)

## Keybindings

| Shortcut | Action |
|----------|--------|
| `Cmd+Shift+V` | Open preview (replaces current pane) |
| `Cmd+K V` | Open preview to the side (split view) |

---

## Project Structure

```
org_viewer/
├── package.json              # Extension manifest (commands, activation, menus, keybindings)
├── tsconfig.json             # TypeScript compiler config
├── esbuild.js                # Bundler — bundles src/ into dist/extension.js
├── .vscode/
│   ├── launch.json           # F5 debug configs for Extension Development Host
│   └── tasks.json            # Build/watch tasks
├── .vscodeignore             # Files excluded from published .vsix
├── .gitignore
├── src/
│   ├── extension.ts          # Entry point: activate() / deactivate(), command registration
│   ├── preview.ts            # WebviewPanel creation, update, disposal, HTML shell
│   ├── orgParser.ts          # Unified pipeline: uniorg-parse → orgMetadata → uniorg-rehype → rehype-raw → rehype-stringify
│   ├── orgMetadata.ts        # Custom uniorg plugin for metadata, checkboxes, display math, drawers, CLOCK
│   └── util.ts               # getNonce(), getUri() helpers
├── media/
│   ├── preview.css           # Theme-aware styles for the rendered preview
│   └── icon.svg              # Split-preview button icon
├── test/
│   ├── runTest.ts            # Test bootstrap (launches VS Code + test suite)
│   └── suite/
│       ├── index.ts          # Mocha runner that discovers *.test.js files
│       ├── orgParser.test.ts # Parser unit tests
│       └── extension.test.ts # Extension integration tests
├── demo/                     # Comprehensive .org test files (8 files, ~2700 lines)
│   ├── basics.org            # Headings, text formatting, entities
│   ├── lists.org             # All list types, checkboxes, nesting
│   ├── links-images.org      # Links, images, footnotes
│   ├── tables.org            # Tables, alignment, formulas
│   ├── code-blocks.org       # Source blocks, example blocks, inline code
│   ├── metadata.org          # Properties, drawers, timestamps, CLOCK
│   ├── blocks.org            # Quote/center/verse/export blocks, LaTeX, horizontal rules
│   └── kitchen-sink.org      # Everything combined in a realistic document
├── debug/                    # Generated HTML output for auditing (not committed)
│   └── *.html                # One per demo file — regenerated by debug workflow
├── plan.md                   # Architecture documentation and implementation plan
└── dist/                     # Build output (not committed)
    └── extension.js          # Bundled extension
```

---

## Architecture

### Parsing Pipeline

The core pipeline in `src/orgParser.ts` uses [unified](https://unifiedjs.com/) with these plugins in order:

```
.org text
  → uniorg-parse          (org text → uniorg AST)
  → orgMetadata            (custom plugin: transforms metadata nodes, adds checkboxes, fixes display math)
  → uniorg-rehype          (uniorg AST → hast/HTML AST)
  → rehype-raw             (processes raw HTML nodes, with passThrough for unknown types)
  → rehypeCleanUnknownNodes (strips any remaining non-standard nodes before serialization)
  → rehype-stringify        (hast → HTML string)
```

### Custom Plugin: `orgMetadata.ts`

This plugin runs at the **uniorg AST level** (before conversion to HTML) and handles features that `uniorg-rehype` silently drops:

| Feature | What the plugin does |
|---------|---------------------|
| `#+TITLE`, `#+AUTHOR`, etc. | Converts `keyword` nodes to bold-label paragraphs |
| SCHEDULED/DEADLINE/CLOSED | Converts `planning` nodes to formatted paragraphs |
| Property drawers | Converts `property-drawer` nodes to key:value displays |
| Custom drawers (LOGBOOK, NOTES) | Converts `drawer` nodes, including their children |
| CLOCK entries | Converts `clock` nodes to bold-label + code-styled time ranges |
| Checkboxes `[X]`/`[ ]`/`[-]` | Injects ☑/☐/☒ Unicode symbols into `list-item` nodes |
| Display math `$$...$$` | Converts `latex-fragment` with `$$` prefix to `latex-environment` for block rendering |

### Webview Panel: `preview.ts`

- Creates a `vscode.WebviewPanel` in a split column
- Injects a full HTML page with the parsed content + CSS
- Uses Content Security Policy (CSP) with nonces
- Tracks panels per document URI to avoid duplicates
- Updates on `onDidChangeTextDocument` and `onDidChangeActiveTextEditor`

### Styles: `media/preview.css`

All styles use VS Code CSS variables (e.g., `--vscode-editor-foreground`) for theme compatibility. Custom colors are used for heading levels, TODO/DONE badges, priority cookies, tags, code blocks, and table headers.

---

## Development Workflow

### Setup

```bash
npm install
```

### Build

```bash
npm run build       # One-time production build
npm run watch       # Watch mode for development
```

### Run & Debug

1. Open the project in VS Code
2. Press **F5** (or select "Run Extension" from the Run & Debug panel)
3. This opens an **Extension Development Host** with the `demo/` folder
4. Open any `.org` file → click the preview icon or press `Cmd+K V`
5. Edit the `.org` file and watch the preview live-update

### Debug Workflow for Rendering Issues

This is the key workflow used during development to identify rendering gaps:

```bash
# 1. Regenerate HTML debug output for all demo files
node -e "
const fs = require('fs');
const path = require('path');
const esbuild = require('esbuild');
esbuild.buildSync({
  entryPoints: ['src/orgParser.ts'],
  bundle: true,
  outfile: '/tmp/orgparser-test.js',
  format: 'cjs',
  platform: 'node',
  external: ['vscode'],
});
const { orgToHtml } = require('/tmp/orgparser-test.js');
const demoDir = './demo';
const debugDir = './debug';
const files = fs.readdirSync(demoDir).filter(f => f.endsWith('.org'));
Promise.all(files.map(async f => {
  const content = fs.readFileSync(path.join(demoDir, f), 'utf8');
  const html = await orgToHtml(content);
  const outName = f.replace('.org', '.html');
  fs.writeFileSync(path.join(debugDir, outName), html);
  console.log(html.includes('org-error') ? 'WARN' : 'OK  ', f, '-', html.length, 'chars');
}));
"

# 2. Compare .org source against .html output to find gaps
# The debug/*.html files can be read by AI agents or opened in a browser
# to identify what's rendering correctly vs. what's missing/wrong
```

### Quick Parser Smoke Test

```bash
node -e "
const esbuild = require('esbuild');
esbuild.buildSync({
  entryPoints: ['src/orgParser.ts'], bundle: true,
  outfile: '/tmp/orgparser-test.js', format: 'cjs',
  platform: 'node', external: ['vscode'],
});
const { orgToHtml } = require('/tmp/orgparser-test.js');
orgToHtml('* Hello\n- [X] Done\n- [ ] Todo\n\n\$\$E=mc^2\$\$').then(console.log);
"
```

---

## Session Handoff Notes

### Current Status (as of 2026-02-07)

**Phase 1 (Scaffolding): COMPLETE**
- npm project initialized with all dependencies
- TypeScript, esbuild, launch.json, tasks.json all configured
- Git repo initialized (no commits yet)

**Phase 2 (Core Extension): COMPLETE**
- `extension.ts` — registers commands, listens for doc changes
- `preview.ts` — WebviewPanel with live update, CSP, per-document tracking
- `orgParser.ts` — full unified pipeline with error handling
- `orgMetadata.ts` — custom plugin for metadata/checkboxes/display-math
- `preview.css` — theme-aware styles with heading colors, code tinting, badge styling
- `icon.svg` — split-preview button icon

**Phase 3 (Demo Files): COMPLETE**
- 8 comprehensive `.org` files covering all syntax (~2700 lines)

**Phase 4 (Testing): SCAFFOLDED**
- Test runner and test files created but not verified running

**Phase 5 (Polish & Publish): NOT STARTED**

### Known Remaining Issues

These were identified through 3 rounds of automated HTML auditing:

**Checkboxes / Lists:**
- Checkboxes inside table cells are not converted to Unicode symbols (only works in list items)
- `[@N]` counter syntax in ordered lists not implemented
- Letter-based ordered lists (`a.`, `b.`) render as numeric

**Math / LaTeX:**
- `\[...\]` display math syntax not converted to block display (only `$$...$$` works)
- Multi-line `$$...$$` that spans across paragraphs may get split into separate fragments
- Some entities (`\LaTeX`, `\copyright`, `\degree`) rendered as math-inline instead of Unicode

**Links / Images:**
- Internal heading links use `*Heading` format instead of `#heading-id` anchors
- Target definitions (`<<target>>`) and radio targets (`<<<target>>>`) rendered as literal text
- Images with descriptions rendered as links instead of `<img>` with alt text

**Tables:**
- Table column alignment specifiers (`<l>`, `<c>`, `<r>`) shown as cell content

**Blocks / Metadata:**
- `#+ATTR_HTML` attributes sometimes attach to the wrong element (e.g. wrapping `<p>` instead of `<img>`)
- `@@latex:...@@` export snippets visible in HTML output (should be hidden)
- `#+NAME:` on source blocks not preserved as HTML id
- `-n` line numbers flag on source blocks ignored
- Inline source blocks (`src_python{...}`) parsed as subscript

**Drawers:**
- Mixed LOGBOOK + PROPERTIES drawers: when both appear under a heading, parsing can be fragile
- `CUSTOM_ID` property values containing underscores may trigger subscript parsing (e.g. `custom-id-section` → `custom-id-<sub>section</sub>`)

**Lower priority / edge cases:**
- Footnotes with complex inline content (lists inside inline footnotes) partially render
- Radio targets don't auto-link subsequent mentions in the document

### How to Continue

1. **Fix remaining parser issues** — Most require adding handlers to `orgMetadata.ts` (uniorg AST level) or custom uniorg-rehype handlers. The pattern is:
   - Check the AST: `unified().use(uniorgParse).parse(orgText)` → inspect the node
   - Add a case to `visitNode()` or `addCheckboxes()` in `orgMetadata.ts`
   - Rebuild: `node esbuild.js`
   - Test: use the debug workflow above

2. **Run the audit cycle** — Regenerate `debug/*.html`, then compare against `demo/*.org` to find gaps. AI agents work well for this: give them both files and ask for a diff of what's missing.

3. **Write tests** — The test scaffolding exists. Run: `npm run compile && npm test`

4. **Publish** — When ready:
   ```bash
   npm install -g @vscode/vsce
   # Set publisher in package.json
   vsce package          # Creates .vsix
   code --install-extension org-viewer-0.0.1.vsix  # Test locally
   vsce publish          # Push to Marketplace (needs Azure PAT)
   ```

### Dependencies

| Package | Purpose |
|---------|---------|
| `uniorg-parse` | Parses `.org` text into uniorg AST |
| `uniorg-rehype` | Converts uniorg AST to hast (HTML AST) |
| `rehype-raw` | Processes raw HTML nodes in the hast tree |
| `rehype-stringify` | Serializes hast to HTML string |
| `unified` | Pipeline orchestrator |
| `uniorg` | Type definitions for the uniorg AST |

### Key Technical Decisions

1. **uniorg over orga** — uniorg has better ecosystem integration (unified/rehype) and more complete Org-mode parsing
2. **Custom orgMetadata plugin** — Rather than forking uniorg-rehype, we intercept at the AST level before conversion. This is cleaner and won't break on library updates.
3. **esbuild over webpack** — Faster builds, simpler config, same output quality
4. **Unicode checkbox symbols** — Injecting ☑/☐/☒ text nodes is simpler and more reliable than HTML checkbox elements in the webview context
5. **Display math via node type swap** — Converting `latex-fragment` ($$) to `latex-environment` leverages uniorg-rehype's existing `div.math.math-display` handler
