#+TITLE: Org Viewer — Developer Reference
#+DATE: 2026-02-11

* Overview

VS Code extension for live-previewing .org (Emacs Org-mode) files. Uses a unified pipeline with a custom AST plugin to handle features that upstream libraries silently drop.

* Project Structure

| Path | Purpose |
|------|---------|
| src/extension.ts | Entry point: activate(), command registration, debounced change handler |
| src/preview.ts | PreviewManager class: WebviewPanel lifecycle, messaging, token counting |
| src/orgParser.ts | Unified pipeline: uniorg-parse → orgMetadata → uniorg-rehype → rehype-raw → rehype-stringify |
| src/orgMetadata.ts | Custom uniorg plugin for metadata, checkboxes, display math, drawers, CLOCK |
| src/webview.ts | Browser-side: highlight.js, collapsible sections, TOC, sticky headings, file ref detection |
| src/tokenCount.ts | Token counting via gpt-tokenizer (cl100k_base encoding) |
| src/util.ts | getNonce(), getUri() helpers |
| media/preview.css | Theme-aware styles, highlight.js Dark+ tokens, TOC sidebar, file ref colors |
| media/preview.js | Bundled webview script (built from src/webview.ts by esbuild) |
| esbuild.js | Dual-target bundler: extension (Node.js/CJS) + webview (browser/IIFE) + tests |
| test/ | Mocha test suite bundled through esbuild |
| demo/ | 8 comprehensive .org test files (~2700 lines) |

* Architecture

** Parsing Pipeline (Server-Side — Node.js)

#+BEGIN_EXAMPLE
.org text
  → uniorg-parse          (org text → uniorg AST, useSubSuperscripts: false)
  → orgMetadata            (custom plugin: transforms metadata nodes, adds checkboxes, fixes display math)
  → uniorg-rehype          (uniorg AST → hast/HTML AST)
  → rehype-raw             (processes raw HTML nodes, with passThrough for unknown types)
  → rehypeCleanUnknownNodes (strips any remaining non-standard nodes before serialization)
  → rehype-stringify        (hast → HTML string)
#+END_EXAMPLE

** Webview Enhancement Pipeline (Client-Side — Browser)

#+BEGIN_EXAMPLE
HTML in webview
  → highlight.js           (syntax highlighting for code blocks)
  → buildSections()        (restructures flat HTML into nested collapsible sections)
  → setStickyOffsets()      (calculates stacked top offsets for sticky headings)
  → linkifyFileReferences() (detects file paths, adds styling + click handlers for .org files)
  → buildToc()             (generates TOC sidebar with token count badge)
  → setupScrollSpy()       (highlights active heading in TOC as user scrolls)
#+END_EXAMPLE

** Custom Plugin: orgMetadata.ts

Runs at the uniorg AST level (before conversion to HTML). Handles features that uniorg-rehype silently drops.

| Feature | What the plugin does |
|---------|---------------------|
| #+TITLE, #+AUTHOR, etc. | Converts keyword nodes to bold-label paragraphs |
| SCHEDULED/DEADLINE/CLOSED | Converts planning nodes to formatted paragraphs |
| Property drawers | Converts property-drawer nodes to key:value displays |
| Custom drawers (LOGBOOK, NOTES) | Converts drawer nodes, including their children |
| CLOCK entries | Converts clock nodes to bold-label + code-styled time ranges |
| Checkboxes [X]/[ ]/[-] | Injects Unicode symbols into list-item nodes |
| Display math $$...$$ | Converts latex-fragment with $$ prefix to latex-environment for block rendering |

** PreviewManager (preview.ts)

| Responsibility | Implementation |
|---------------|----------------|
| Panel lifecycle | One panel per document URI, tracks in Map |
| Follow mode | Reuses "beside" panel when switching .org files |
| Live update | Debounced (300ms) via extension.ts |
| Token counting | Counts via gpt-tokenizer, embeds as data attribute |
| File navigation | Handles webview messages to open .org references in editor |
| CSP | Nonces for both styles and scripts |

** File Reference Detection (webview.ts)

| File Type | Extensions | Color | Clickable |
|-----------|-----------|-------|-----------|
| org | .org | Blue (#4fc1ff) | Yes — opens in editor |
| doc | .md, .mdx, .rst, .txt | Purple (#c586c0) | No |
| code | .py, .js, .ts, .rs, .go, .java, etc. | Yellow (#dcdcaa) | No |
| config | .json, .yaml, .toml, .xml, .html, .css, etc. | Orange (#ce9178) | No |

* Dependencies

| Package | Purpose |
|---------|---------|
| uniorg-parse | Parses .org text into uniorg AST |
| uniorg-rehype | Converts uniorg AST to hast (HTML AST) |
| rehype-raw | Processes raw HTML nodes in the hast tree |
| rehype-stringify | Serializes hast to HTML string |
| unified | Pipeline orchestrator |
| uniorg | Type definitions for the uniorg AST |
| highlight.js | Syntax highlighting for code blocks in the webview |
| gpt-tokenizer | Token counting (cl100k_base encoding) |

* Key Technical Decisions

| Decision | Rationale |
|----------|-----------|
| uniorg over orga | Better ecosystem integration (unified/rehype), more complete Org-mode parsing |
| Custom orgMetadata plugin | Intercepts at AST level before uniorg-rehype; won't break on library updates |
| useSubSuperscripts: false | Disables sub/superscript parsing at parser level; trust LaTeX for real subscripts |
| esbuild dual-target | Two bundles: extension (Node.js/CJS) and webview (browser/IIFE); faster than webpack |
| Client-side DOM restructuring | Sections, sticky headings, TOC built by webview script; keeps parser clean |
| highlight.js common bundle | ~40 languages instead of 190+; keeps webview bundle lean |
| Stacked sticky via offsetHeight | Pixel-accurate regardless of font size |
| Unicode checkbox symbols | Simpler than HTML checkbox elements in webview context |
| Display math via node type swap | Leverages uniorg-rehype's existing div.math.math-display handler |

* Development

** Setup & Build

#+BEGIN_EXAMPLE
npm install
npm run build       # One-time production build
npm run watch       # Watch mode for development
#+END_EXAMPLE

** Run & Debug

1. Open the project in VS Code
2. Press F5 (or select "Run Extension" from the Run & Debug panel)
3. Opens an Extension Development Host with the demo/ folder
4. Open any .org file → click preview icon or press Cmd+K V

** Debug Workflow for Rendering Issues

#+BEGIN_EXAMPLE
# Regenerate HTML debug output for all demo files
node -e "
const fs = require('fs');
const path = require('path');
const esbuild = require('esbuild');
esbuild.buildSync({
  entryPoints: ['src/orgParser.ts'],
  bundle: true,
  outfile: '/tmp/orgparser-test.js',
  format: 'cjs',
  platform: 'node',
  external: ['vscode'],
});
const { orgToHtml } = require('/tmp/orgparser-test.js');
const demoDir = './demo';
const debugDir = './debug';
const files = fs.readdirSync(demoDir).filter(f => f.endsWith('.org'));
Promise.all(files.map(async f => {
  const content = fs.readFileSync(path.join(demoDir, f), 'utf8');
  const html = await orgToHtml(content);
  const outName = f.replace('.org', '.html');
  fs.writeFileSync(path.join(debugDir, outName), html);
  console.log(html.includes('org-error') ? 'WARN' : 'OK  ', f, '-', html.length, 'chars');
}));
"
#+END_EXAMPLE

** Publishing

#+BEGIN_EXAMPLE
npm install -g @vscode/vsce
vsce package          # Creates .vsix
vsce publish          # Push to Marketplace (needs Azure PAT)
#+END_EXAMPLE

* Known Remaining Issues

** Checkboxes / Lists
- Checkboxes inside table cells not converted to Unicode symbols (only works in list items)
- [@N] counter syntax in ordered lists not implemented
- Letter-based ordered lists (a., b.) render as numeric

** Math / LaTeX
- \[...\] display math syntax not converted to block display (only $$...$$ works)
- Multi-line $$...$$ spanning paragraphs may get split into separate fragments
- Some entities (\LaTeX, \copyright, \degree) rendered as math-inline instead of Unicode

** Links / Images
- Internal heading links use *Heading format instead of #heading-id anchors
- Target definitions (<<target>>) and radio targets (<<<target>>>) rendered as literal text
- Images with descriptions rendered as links instead of <img> with alt text

** Tables
- Column alignment specifiers (<l>, <c>, <r>) shown as cell content

** Blocks / Metadata
- #+ATTR_HTML attributes sometimes attach to wrong element
- @@latex:...@@ export snippets visible in HTML output (should be hidden)
- #+NAME: on source blocks not preserved as HTML id
- -n line numbers flag on source blocks ignored

** Lower Priority
- Footnotes with complex inline content partially render
- Radio targets don't auto-link subsequent mentions

---
/Last Updated/: 2026-02-11
