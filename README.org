#+TITLE: Org Viewer — Developer Reference
#+DATE: 2026-02-11

* Overview

VS Code extension for live-previewing .org (Emacs Org-mode) and .md (Markdown) files. Uses the unified ecosystem with format-specific parser pipelines and a shared webview rendering layer.

* Project Structure

| Path | Purpose |
|------|---------|
| src/extension.ts | Entry point: activate(), command registration, debounced change handler |
| src/preview.ts | PreviewManager class: WebviewPanel lifecycle, messaging, token counting |
| src/parsers/index.ts | Parser dispatch: routes languageId to the correct parser |
| src/parsers/orgParser.ts | Org pipeline: uniorg-parse → orgMetadata → uniorg-rehype → rehype-raw → rehype-stringify |
| src/parsers/orgMetadata.ts | Custom uniorg plugin for metadata, checkboxes, display math, drawers, CLOCK |
| src/parsers/mdParser.ts | Markdown pipeline: remark-parse → remark-gfm → remark-rehype → rehype-raw → rehype-stringify |
| src/webview.ts | Browser-side: highlight.js, collapsible sections, TOC, sticky headings, file ref detection, doc map, template view |
| src/templateContent.ts | Embedded documentation philosophy template (.org text constant) |
| src/tokenCount.ts | Token counting via gpt-tokenizer (cl100k_base encoding) |
| src/util.ts | getNonce(), getUri() helpers |
| media/preview.css | Theme-aware styles, highlight.js Dark+ tokens, TOC sidebar, file ref colors |
| media/preview.js | Bundled webview script (built from src/webview.ts by esbuild) |
| esbuild.js | Dual-target bundler: extension (Node.js/CJS) + webview (browser/IIFE) + tests |
| test/ | Mocha test suite bundled through esbuild |
| demo/ | .org test files (~2700 lines) + .md test files for markdown preview |

* Architecture

** Parsing Pipelines (Server-Side — Node.js)

The parser dispatch (src/parsers/index.ts) routes to the correct pipeline based on VS Code languageId:

#+BEGIN_EXAMPLE
                    ┌─ org:  uniorg-parse → orgMetadata → uniorg-rehype ─┐
raw text → dispatch ┤                                                      ├→ rehype-raw → rehype-stringify → HTML
                    └─ md:   remark-parse → remark-gfm → remark-rehype  ─┘
#+END_EXAMPLE

*** Org Pipeline (src/parsers/orgParser.ts)

#+BEGIN_EXAMPLE
.org text
  → uniorg-parse          (org text → uniorg AST, useSubSuperscripts: false)
  → orgMetadata            (custom plugin: transforms metadata nodes, adds checkboxes, fixes display math)
  → uniorg-rehype          (uniorg AST → hast/HTML AST)
  → rehype-raw             (processes raw HTML nodes, with passThrough for unknown types)
  → rehypeCleanUnknownNodes (strips any remaining non-standard nodes before serialization)
  → rehype-stringify        (hast → HTML string)
#+END_EXAMPLE

*** Markdown Pipeline (src/parsers/mdParser.ts)

#+BEGIN_EXAMPLE
.md text
  → remark-parse           (markdown text → mdast)
  → remark-gfm             (GitHub-Flavored Markdown: tables, task lists, strikethrough)
  → remark-rehype          (mdast → hast/HTML AST)
  → rehype-raw             (processes raw HTML in markdown)
  → rehype-stringify        (hast → HTML string)
#+END_EXAMPLE

** Webview Enhancement Pipeline (Client-Side — Browser)

Shared by both formats. Operates on the final HTML output.

#+BEGIN_EXAMPLE
HTML in webview
  → highlight.js           (syntax highlighting for code blocks)
  → buildSections()        (restructures flat HTML into nested collapsible sections)
  → setStickyOffsets()      (calculates stacked top offsets for sticky headings)
  → linkifyFileReferences() (detects file paths, adds styling + click handlers for .org/.md files)
  → buildToc()             (generates TOC sidebar with token count badge)
  → buildViewToggle()      (Preview / Doc Map toggle bar)
  → setupScrollSpy()       (highlights active heading in TOC as user scrolls)
  → setupMessageListener() (receives Doc Map data from extension host)
#+END_EXAMPLE

** Custom Plugin: orgMetadata.ts

Runs at the uniorg AST level (before conversion to HTML). Handles features that uniorg-rehype silently drops.

| Feature | What the plugin does |
|---------|---------------------|
| #+TITLE, #+AUTHOR, etc. | Converts keyword nodes to bold-label paragraphs |
| SCHEDULED/DEADLINE/CLOSED | Converts planning nodes to formatted paragraphs |
| Property drawers | Converts property-drawer nodes to key:value displays |
| Custom drawers (LOGBOOK, NOTES) | Converts drawer nodes, including their children |
| CLOCK entries | Converts clock nodes to bold-label + code-styled time ranges |
| Checkboxes [X]/[ ]/[-] | Injects Unicode symbols into list-item nodes |
| Display math $$...$$ | Converts latex-fragment with $$ prefix to latex-environment for block rendering |

** PreviewManager (preview.ts)

| Responsibility | Implementation |
|---------------|----------------|
| Panel lifecycle | One panel per document URI, tracks in Map |
| Follow mode | Reuses "beside" panel when switching .org/.md files |
| Live update | Debounced (300ms) via extension.ts |
| Parser dispatch | Calls parseToHtml(text, languageId) from parsers/index.ts |
| Token counting | Counts via gpt-tokenizer, embeds as data attribute |
| File navigation | Handles webview messages to open .org/.md references in editor |
| Doc Map discovery | Scans workspace for .org files, classifies by layer, sends to webview |
| CSP | Nonces for both styles and scripts |

** Template Tab (preview.ts + webview.ts + templateContent.ts)

Toggle to a documentation philosophy template that users can copy into their projects. The template is embedded as a string constant in templateContent.ts (avoids filesystem reads and packaging issues). The extension host parses the .org text through the org pipeline and sends rendered HTML + raw text to the webview. A "Copy to Clipboard" button copies the raw .org source.

The template covers: present-state-only documentation, two-layer file structure (strategic + quick reference), AI-first formatting, agent roles, maintenance workflows, and common violations.

** Doc Map (preview.ts + webview.ts)

Toggle between the rendered preview and a workspace-wide documentation map. The extension host scans for all .org files and classifies them into three layers:

| Layer | Rule | Color |
|-------|------|-------|
| Strategic | Root-level files or ALL_CAPS .org one level deep | Blue (#4fc1ff) |
| Quick Reference | Any file named quick_reference.org | Purple (#c586c0) |
| Other | Everything else | Teal (#9cdcfe) |

Note: The Doc Map only shows .org files — these are treated as primary documentation files for LLM context. Markdown files are not included in the Doc Map.

Quick reference files are grouped by parent directory. All files are clickable to navigate. The currently viewed file is highlighted.

** File Reference Detection (webview.ts)

| File Type | Extensions | Color | Clickable |
|-----------|-----------|-------|-----------|
| org / md | .org, .md | Blue (#4fc1ff) | Yes — opens in editor |
| doc | .mdx, .rst, .txt | Purple (#c586c0) | No |
| code | .py, .js, .ts, .rs, .go, .java, etc. | Yellow (#dcdcaa) | No |
| config | .json, .yaml, .toml, .xml, .html, .css, etc. | Orange (#ce9178) | No |

* Dependencies

| Package | Purpose |
|---------|---------|
| uniorg-parse | Parses .org text into uniorg AST |
| uniorg-rehype | Converts uniorg AST to hast (HTML AST) |
| uniorg | Type definitions for the uniorg AST |
| remark-parse | Parses markdown text into mdast |
| remark-gfm | GitHub-Flavored Markdown support (tables, task lists, strikethrough) |
| remark-rehype | Converts mdast to hast (HTML AST) |
| rehype-raw | Processes raw HTML nodes in the hast tree |
| rehype-stringify | Serializes hast to HTML string |
| unified | Pipeline orchestrator |
| highlight.js | Syntax highlighting for code blocks in the webview |
| gpt-tokenizer | Token counting (cl100k_base encoding) |

* Key Technical Decisions

| Decision | Rationale |
|----------|-----------|
| Dual-format via parser dispatch | Single webview layer shared by both formats; parsers isolated in src/parsers/ |
| uniorg over orga | Better ecosystem integration (unified/rehype), more complete Org-mode parsing |
| remark + remark-gfm for markdown | Same unified ecosystem as org pipeline; GFM adds tables, task lists, strikethrough |
| Custom orgMetadata plugin | Intercepts at AST level before uniorg-rehype; won't break on library updates |
| useSubSuperscripts: false | Disables sub/superscript parsing at parser level; trust LaTeX for real subscripts |
| esbuild dual-target | Two bundles: extension (Node.js/CJS) and webview (browser/IIFE); faster than webpack |
| Client-side DOM restructuring | Sections, sticky headings, TOC built by webview script; keeps parser clean |
| highlight.js common bundle | ~40 languages instead of 190+; keeps webview bundle lean |
| Stacked sticky via offsetHeight | Pixel-accurate regardless of font size |
| Doc Map: .org only | .org files are primary LLM documentation; .md files excluded to keep Doc Map focused |
| Keybindings: .org only | Avoids conflicting with VS Code's built-in markdown preview keybindings |

* Development

** Setup & Build

#+BEGIN_EXAMPLE
npm install
npm run build       # One-time production build
npm run watch       # Watch mode for development
#+END_EXAMPLE

** Run & Debug

1. Open the project in VS Code
2. Press F5 (or select "Run Extension" from the Run & Debug panel)
3. Opens an Extension Development Host with the demo/ folder
4. Open any .org or .md file → click preview icon or press Cmd+K V (for .org) / use command palette (for .md)

** Debug Workflow for Rendering Issues

#+BEGIN_EXAMPLE
# Regenerate HTML debug output for all demo files
node -e "
const fs = require('fs');
const path = require('path');
const esbuild = require('esbuild');
esbuild.buildSync({
  entryPoints: ['src/parsers/orgParser.ts'],
  bundle: true,
  outfile: '/tmp/orgparser-test.js',
  format: 'cjs',
  platform: 'node',
  external: ['vscode'],
});
const { orgToHtml } = require('/tmp/orgparser-test.js');
const demoDir = './demo';
const debugDir = './debug';
const files = fs.readdirSync(demoDir).filter(f => f.endsWith('.org'));
Promise.all(files.map(async f => {
  const content = fs.readFileSync(path.join(demoDir, f), 'utf8');
  const html = await orgToHtml(content);
  const outName = f.replace('.org', '.html');
  fs.writeFileSync(path.join(debugDir, outName), html);
  console.log(html.includes('parse-error') ? 'WARN' : 'OK  ', f, '-', html.length, 'chars');
}));
"
#+END_EXAMPLE

** Publishing

#+BEGIN_EXAMPLE
npm install -g @vscode/vsce
vsce package          # Creates .vsix
vsce publish          # Push to Marketplace (needs Azure PAT)
#+END_EXAMPLE

* Known Remaining Issues

** Checkboxes / Lists (Org)
- Checkboxes inside table cells not converted to Unicode symbols (only works in list items)
- [@N] counter syntax in ordered lists not implemented
- Letter-based ordered lists (a., b.) render as numeric

** Math / LaTeX (Org)
- \[...\] display math syntax not converted to block display (only $$...$$ works)
- Multi-line $$...$$ spanning paragraphs may get split into separate fragments
- Some entities (\LaTeX, \copyright, \degree) rendered as math-inline instead of Unicode

** Links / Images (Org)
- Internal heading links use *Heading format instead of #heading-id anchors
- Target definitions (<<target>>) and radio targets (<<<target>>>) rendered as literal text
- Images with descriptions rendered as links instead of <img> with alt text

** Tables (Org)
- Column alignment specifiers (<l>, <c>, <r>) shown as cell content

** Blocks / Metadata (Org)
- #+ATTR_HTML attributes sometimes attach to wrong element
- @@latex:...@@ export snippets visible in HTML output (should be hidden)
- #+NAME: on source blocks not preserved as HTML id
- -n line numbers flag on source blocks ignored

** Line Spacing / Code Blocks
- Code block and example block line-height set to 1.2 in preview.css (pre, .example)
- ASCII art diagrams need low line-height (~1.0–1.2) for box-drawing characters to connect vertically
- VS Code webviews inject default styles that can override extension CSS; the rule =.doc-preview pre, .doc-preview pre code { line-height: 1.2 }= uses higher specificity to win
- If diagrams still show gaps, lower the value toward 1.0; if regular code feels too cramped, raise toward 1.3
- Section indent controlled by =.section-body= padding-left (0.75rem) + margin-left (0.2rem) in preview.css

** Lower Priority
- Footnotes with complex inline content partially render
- Radio targets don't auto-link subsequent mentions

---
/Last Updated/: 2026-02-27
